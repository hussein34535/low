'use client';
import { useState, useRef, useEffect } from 'react';

const originalData = [
    // --- قسم الجنسية ---
    { cat: "الجنسية", q: "عرف الجنسية؟", a: "هي رابطة اجتماعية وسياسية ذات نتائج قانونية وتفيد انتماء فرد لعنصر السكان في دولة معينة." },
    { cat: "الجنسية", q: "ما هي أركان الجنسية؟", a: "الركن الأول: وجود الدولة. الركن الثاني: وجود الفرد. الركن الثالث: وجود رابطة قانونية بين هذا الفرد وتلك الدولة." },
    { cat: "الجنسية", q: "ما هي القواعد العامة لاكتساب الجنسية المصرية الأصلية؟", a: "أولاً - حق الدم. ثانياً - حق الإقليم." },
    { cat: "الجنسية", q: "ما المقصود بحق الدم؟", a: "يقصد بحق الدم حق الفرد في اكتساب جنسية الدولة التي ينتمي إليها أحد والديه بمجرد الميلاد، وبصرف النظر عن مكان ولادته." },
    { cat: "الجنسية", q: "ما المقصود بحق الإقليم؟", a: "حق الشخص في اكتساب جنسية الدولة التي ولد على إقليمها وبغض النظر عن جنسية والديه." },
    { cat: "الجنسية", q: "ما هي أنواع الجنسية المصرية؟", a: "١) الجنسية الأصلية. ٢) الجنسية الطارئة أو المكتسبة." },
    { cat: "الجنسية", q: "ما المقصود بالجنسية الأصلية؟", a: "هي الجنسية التي يكتسبها الشخص من لحظة الميلاد." },
    { cat: "الجنسية", q: "ما هي الجنسية الطارئة أو المكتسبة؟", a: "هي الجنسية التي يكتسبها الفرد في تاريخ لاحق على الميلاد." },
    { cat: "الجنسية", q: "ما الفرق بين الجنسية الأصلية والجنسية الطارئة أو المكتسبة؟", a: "١) الجنسية الأصلية يكتسبها الفرد منذ لحظة الميلاد، أما الجنسية الطارئة تكتسب بعد الميلاد. ٢) الجنسية الأصلية تفرض ولا تطلب، أما الجنسية الطارئة تطلب ولا تفرض." },
    { cat: "الجنسية", q: "ما هي حالات اكتساب الجنسية أو أسس اكتساب الجنسية المصرية الأصلية؟", a: "١) الجنسية المصرية الأصلية المبنية على حق الدم. ٢) الجنسية المصرية الأصلية المبنية على حق الإقليم." },
    { cat: "الجنسية", q: "ما هي شروط اكتساب الجنسية المصرية الأصلية بناء على حق الدم؟", a: "١) الميلاد لأب مصرى أو لأم مصرية. ٢) ثبوت نسب المولود لأبيه قانوناً ولأمه واقعياً." },
    { cat: "الجنسية", q: "ما هي شروط اكتساب الجنسية المصرية الأصلية بناء على حق الإقليم؟", a: "١) تحقق واقعة الميلاد على الإقليم المصرى. ٢) جهالة الأبوين." },
    { cat: "الجنسية", q: "ما هي طرق ثبوت النسب وفقاً للقانون المصرى؟", a: "١) فراش الزوجية. ٢) البينة. ٣) الإقرار." },
    { cat: "الجنسية", q: "ما هي الأسس العامة لاكتساب الجنسية الطارئة؟", a: "١) الميلاد بالإقليم مدعماً بالإقامة. ٢) تغيير السيادة الإقليمية. ٣) التجنس. ٤) الزواج المختلط. ٥) الاستثمار." },
    { cat: "الجنسية", q: "عرف التجنس؟", a: "يقصد بالتجنس أن يصير الأجنبي المستوفي للشروط المنصوص عليها في القانون الوطني بناء على الاستجابة التقديرية للدولة وطلباً من خلال تقديمه لطلب للجهة المختصة بمنح الجنسية." },
    { cat: "الجنسية", q: "ما هي أركان التجنس؟", a: "الركن الأول: التعبير الصريح عن رغبة الفرد في الدخول في جنسية الدولة. الركن الثاني: موافقة الدولة على دخول الفرد في جنسيتها." },
    { cat: "الجنسية", q: "ما هي شروط التجنس؟", a: "١) الشروط اللازمة لاندماج الأجنبي في الجماعة الوطنية: أ) إقامة الأجنبي طالب التجنس في إقليم الدولة خلال فترة معينة. ب) ضرورة الإلمام باللغة الوطنية. ج) معرفة تاريخ الدولة ونظام الحكم فيها. ٢) الشروط التي تقتضيها سيادة مجتمع الدولة: أ) حسن سير وسلوك طالب التجنس. ب) عدم اعتناقه لمبادئ سياسية أو اجتماعية من شأنها التعارض مع نظام الدولة. ج) القدرة على كسب الرزق بطرق مشروعة. د) سلامة طالب التجنس من الأمراض البدنية والعقلية. ٣) الشروط المتعلقة بالإقليم: توافر الأهلية اللازمة للتعبير عن إرادة التجنس لدى طالب التجنس وفقاً لقانون الدولة التي يرغب في الحصول على جنسيتها." },
    { cat: "الجنسية", q: "ما هي السلطة المختصة بالفصل في طلب التجنس في مصر؟", a: "يعود المشرع المصري بهذه المهمة لوزير الداخلية." },
    { cat: "الجنسية", q: "ما هي آثار التجنس؟", a: "يترتب على منح الدولة جنسيتها لطالب التجنس نوعين من الآثار: الأول: يتعلق بشخص المتجنس: فإنه بمجرد التجنس يصبح وطنياً، وتنتفي عنه صفة الأجنبي، ويتمتع بالحقوق ويتحمل بالالتزامات التي تقع على عاتق المواطنين. الثاني: يتعلق بأسرة المتجنس: ١- بالنسبة لزوجة المتجنس: الأصل لا يؤثر التجنس على جنسية الزوجة. ٢- بالنسبة للأولاد البالغين سن الرشد: لا تتأثر جنسيتهم بجنسية أبوهم الجديد. ٣- بالنسبة للأولاد القصر: جرت غالبية التشريعات على امتداد الجنسية الجديدة للأب إليهم." },
    { cat: "الجنسية", q: "عرف الزواج المختلط؟", a: "يقصد بالزواج المختلط ذلك الزواج الذي ينعقد بين طرفين من جنسيتين مختلفتين." },
    { cat: "الجنسية", q: "ما هي مبررات الأخذ بالاستثمار كأحد أسس التجنس؟", a: "١) جذب رؤوس الأموال الأجنبية وتعزيز خطط التنمية. ٢) تشجيع الانفتاح الاقتصادي في ظل العولمة والمنافسة بين الدول. ٣) تحقيق مصلحة مزدوجة بين الدولة والمستثمر." },
    { cat: "الجنسية", q: "ما هي الانتقادات الموجهة للتجنس بالاستثمار؟", a: "١) تعارض التجنس بالاستثمار مع المفهوم التقليدي للجنسية كرابطة ولاء وانتماء. ٢) تجسيد التجنس بالاستثمار لتمييز غير مبرر لصالح الأثرياء. ٣) المخاطر الأمنية واحتمالات إساءة الاستغلال." },
    { cat: "الجنسية", q: "ما هي أسس اكتساب الجنسية المصرية الطارئة؟", a: "١) الجنسية المصرية الطارئة بناء على الميلاد مدعماً بعوامل أخرى. ٢) الجنسية المصرية الطارئة بناء على التجنس. ٣) الجنسية المصرية الطارئة بناء على الزواج المختلط. ٤) الجنسية المصرية على أساس الاستثمار." },
    { cat: "الجنسية", q: "ما هي حالات اكتساب الجنسية المصرية الطارئة على أساس الميلاد والإقامة؟", a: "الحالة الأولى: الميلاد في مصر لأب من أصل مصرى والإقامة العادية بها حتى بلوغ سن الرشد. الحالة الثانية: الميلاد في مصر والإقامة العادية فيها حتى بلوغ سن الرشد. الحالة الثالثة: الميلاد المضاعف في مصر." },
    { cat: "الجنسية", q: "ما هي شروط الأصل المصرى أو شروط اعتبار الشخص من أصل مصرى؟", a: "١- أن يكون مصرى الجنسية: ويعتبر من أصل مصري كل من يظهر بمظهر المصري، ويستلزم لتوافر هذا المظهر ثلاث شروط في الاسم والشهرة والمعاملة أي يحمل اسماً مصرياً، وأن يشتهر بين الناس بأنه مصري، وأن يعامل على هذا الأساس. ٢- ألا يكون هذا الشخص قد دخل في جنسية التأسيس بسبب تخلف ركن الإقامة أو العجز عن إثباتها. ٣- أن يكون أحد أصوله أو أصول الزوج مولوداً في مصر." },
    { cat: "الجنسية", q: "ما المقصود بالميلاد المضاعف؟", a: "يقصد بالميلاد المضاعف ميلاد طالب التجنس وأبويه أو أمه في مصر." },
    { cat: "الجنسية", q: "ما هي شروط اكتساب الجنسية بناء على الميلاد المضاعف في مصر؟", a: "الشرط الأول: الميلاد المضاعف. الشرط الثاني: أن يكون طالب التجنس منتمياً إلى غالبية السكان في بلد لغته العربية أو دينه الإسلام. الشرط الثالث: التقدم بطلب التجنس خلال سنة من تاريخ بلوغ طالب التجنس سن الرشد." },
    { cat: "الجنسية", q: "ما هي حالات اكتساب الجنسية المصرية بناء على التجنس؟", a: "الحالة الأولى: الإقامة العادية في مصر عشر سنوات متتالية على الأقل سابقة على تقديم طلب التجنس. الحالة الثانية: الإقامة العادية في مصر خمس سنوات والمقترنة بتوافر الأصل المصري. الحالة الثالثة: التجنس الذي لا يستند إلى الميلاد أو الإقامة في مصر." },
    { cat: "الجنسية", q: "ما هو التجنس الذي لا يستند إلى الميلاد أو الإقامة في مصر (التجنس ذو الصفة الاستثنائية)؟", a: "يجوز بقرار من رئيس الجمهورية منح الجنسية المصرية دون التقيد بأي أساس من أسس اكتساب الجنسية الطارئة لكل من: الطائفة الأولى: من قدم خدمات جليلة لمصر. الطائفة الثانية: رؤساء الطوائف الدينية." },
    { cat: "الجنسية", q: "ما هي شروط اكتساب الزوجة الأجنبية المتزوجة من مصرى الجنسية المصرية (الزواج المختلط)؟", a: "الشرط الأول: الزواج صحيح ورسمي. الشرط الثاني: إعلان الزوجة رغبتها في الدخول في الجنسية المصرية. الشرط الثالث: استمرار الزوجية مدة سنتين من تاريخ إعلان الرغبة. الشرط الرابع: عدم صدور قرار مسبب من وزير الداخلية خلال السنتين المذكورتين بحرمان الزوجة من حق الدخول في الجنسية." },
    { cat: "الجنسية", q: "ما هي الآثار المترتبة على التجنس بالاستثمار؟", a: "١) انتقال الجنسية إلى الزوجة والأبناء القصر تبعاً للمستثمر. ٢) تمتع المستثمر المتجنس بجميع الحقوق المدنية والسياسية. ٣) الخضوع للالتزامات والواجبات المقررة على المواطنين. ٤) السلطة التقديرية للدولة في سحب الجنسية أو إسقاطها." },
    { cat: "الجنسية", q: "ما هو أثر التجنس بالجنسية المصرية؟", a: "١) دخول المتجنس في الجنسية المصرية أن يصبح وطنياً. ٢) يعتبر مبدأ استقلال جنسية الزوجة فلا يؤثر التجنس على جنسية الزوجة وإنما تحتفظ بجنسيتها. ٣) يرتب القانون المصرى على اكتساب الأب للجنسية المصرية أثراً تبعياً على جنسية الأبناء القصر فيدخلون الجنسية المصرية بقوة القانون كأثر حتمي لتجنس أبوهم بها. ٤) التجنس لا يؤثر على الأولاد البالغين سن الرشد." },
    { cat: "الجنسية", q: "ما هي حالات فقد الجنسية المصرية الطارئة؟", a: "١) فقد الجنسية بالتخيير. ٢) فقد الجنسية بالتجريد." },
    { cat: "الجنسية", q: "ما الفرق بين فقد الجنسية بالتخيير وفقدها بالتجريد؟", a: "فقد الجنسية بالتخيير يكون بإرادة الفرد ذاته حين يختار الانضمام الى جنسية أجنبية، أما فقد الجنسية بالتجريد يكون بإرادة الدولة التي قد ترى مبرراً لسحب الجنسية أو إسقاطها كجزاء على إخلاله بواجباته نحوها." },
    { cat: "الجنسية", q: "ما هي صور فقد الجنسية المصرية بالتخيير؟", a: "١) فقد الجنسية نتيجة لتجنس الوطني بجنسية أخرى، مما يترتب عليه فقد جنسيته الوطنية. ٢) فقد الجنسية نتيجة للزواج المختلط، فتفقد المرأة الوطنية جنسيتها إذا ما تزوجت بأجنبي نتيجة لهذا الزواج. ٣) فقد الجنسية الوطنية لزوال أسباب اكتسابها." },
    { cat: "الجنسية", q: "ما هي صور فقد الجنسية بالتجريد؟", a: "١) السحب. ٢) الإسقاط." },
    { cat: "الجنسية", q: "عرف سحب الجنسية؟", a: "هو جزاء توقعه الدولة على الوطني الطارئ خلال فترة الريبة، إذا تبين عدم صلاحيته للاستمرار في حمل جنسيتها." },
    { cat: "الجنسية", q: "عرف إسقاط الجنسية؟", a: "الإسقاط هو عبارة عن إجراء بمقتضاه تقوم الدولة بتجريد الوطني من جنسيته في أي لحظة." },
    { cat: "الجنسية", q: "ما الفرق بين السحب والاسقاط؟", a: "أولاً: حق الدولة في إسقاط الجنسية غير محدد بمدة وبالتالي تستطيع الدولة اللجوء إليه في أي وقت، أما السحب فهو إما أن يكون مقيد بمدة العشر سنوات أو مدة الخمس سنوات من تاريخ اكتساب الجنسية. ثانياً: الإسقاط جزاء يشمل جميع الأفراد الذين ينتمون للدولة بجنسيتهم سواء كانوا من الوطنيين الأصلاء أو من الوطنيين الطارئين، أما السحب يشمل الوطنيين الطارئين فقط." },
    { cat: "الجنسية", q: "ما هي أسباب سحب الجنسية؟", a: "١- عدم أمانة الشخص في اكتسابه لجنسية الدولة كما لو اكتسب الأجنبي جنسية الدولة بناء على إدلائه لأقوال كاذبة أو تقديمه أوراقات غير صحيحة أو مزورة. ٢- عدم الإيفاء على الاندماج في الجماعة الوطنية. ٣- عدم الصلاحية للجماعة الوطنية: فيجوز سحب الجنسية من الوطني الطارئ إذا ارتكب جريمة من الجرائم المنصوص عليها قانوناً والتي تنبئ عن عدم سلامة ذمته أو عدم ولائه للدولة." },
    { cat: "الجنسية", q: "ما هي أسباب إسقاط الجنسية؟", a: "١- عدم الولاء للدولة. ٢- عدم الاندماج في الجماعة الوطنية. ٣- عدم الصلاحية للجماعة الوطنية." },
    { cat: "الجنسية", q: "ما الفرق بين استرداد الجنسية وردها؟", a: "يتفق الرد مع الاسترداد في أن كلاهما طريق للعودة إلى الجنسية بعد فقدها، غير أن الفقد الذي يسبق الاسترداد يتم بعمل إرادي من جانب الفرد، أو بحكم القانون بينما الفقد الذي يسبق الرد يقع على سبيل الجزاء إما بسحب الجنسية أو إسقاطها. كذلك رد الجنسية مجرد رخصة تخضع لتقدير الدولة. أما الاسترداد فنجدهم في السلطة التقديرية للدولة خاصة في الحالات التي يكون فيها الاسترداد منوطاً بإرادة الفرد وحده، كما في حالة استرداد الأولاد القصر لجنسية أبيهم الأولى عند بلوغهم سن الرشد." },
    { cat: "الجنسية", q: "ما الفرق بين الاسترداد وطرق اكتساب الجنسية الطارئة؟", a: "ويتفق الاسترداد مع الجنسية الطارئة في أنه لا يترتب عليه أي أثر رجعي، بمعنى أن العودة اللاحقة لجنسية سابقة لا تزيل عن الشخص صفة الأجنبي في الفترة التي تقع بين فقد الجنسية واستردادها. ودعم ذلك فإن الاسترداد يختلف عن طرق اكتساب الجنسية الطارئة في أمور عدة هي: ١- الاسترداد يفترض تحقق تمتع الفرد بجنسية الدولة ثم فقدها. ٢- وجود اعتبار من اعتبارات من العدالة كما في حالة الأولاد القصر الذين فقدوا الجنسية بالتبعية لوالدهم، فهذا الفقد مبني على إرادة مفروضة قبلهم، فمن العدل أن يعاد بإرادتهم الحقيقية متى بلغوا سن الرشد. ٣- أن الشخص الذي يسترد جنسيته الوطنية القديمة لا يعامل معاملة الأجنبي الذي أصبح وطنياً بناء على سبب من أسباب اكتساب الجنسية الوطنية الطارئة، وذلك أن المسترد لجنسيته لا يخضع لفترة الحرمان التي يخضع لها الوطني الطارئ والتي يحرم في خلالها من التمتع بالحقوق المقصورة على الوطنيين الأصلاء." },
    { cat: "الجنسية", q: "شروط لفقد الجنسية المصرية بالتجنس بجنسية دولة أجنبية؟", a: "الشرط الأول: الحصول مقدماً على إذن بالتجنس من السلطة التنفيذية. الشرط الثاني: دخول الوطني فعلاً في الجنسية الأجنبية." },
    { cat: "الجنسية", q: "شروط فقد الزوجة المتزوجة بأجنبي الجنسية المصرية؟", a: "١- أن تبدى الزوجة رغبتها في الدخول في جنسية زوجها. ٢- أن تعلن الزوجة وزير الداخلية برغبتها في دخول جنسية زوجها الجديدة. ٣- أن تكون الزوجة قد دخلت بالفعل في جنسية زوجها. ٤- أن يكون الزواج صحيحاً طبقاً لأحكام القانون المصري." },
    { cat: "الجنسية", q: "حالات سحب الجنسية المصرية؟", a: "أ- حالات السحب الحتمي: إذا حكم عليه في مصر بعقوبة جناية أو بعقوبة مقيدة للحرية في جريمة بالشرف. ب- إذا حكم عليه قضائياً في جريمة من الجرائم الماسة بأمن الحكومة من جهة الخارج أو من جهة الداخل. ج- إذا كان قد انقطع عن الإقامة في جمهورية مصر العربية مدة سنتين متتاليتين وكان ذلك الانقطاع بلا عذر يقبله وزير الداخلية. د- حالات السحب العشري: لم ينص المشرع سوى على حالة واحدة تجيز لمجلس الوزراء أن يتخذ إجراء السحب في خلال العشر سنوات التالية لتجنس الشخص بالجنسية المصرية المكتسبة، وهذه الحالة تتعلق بكل من اكتسب جنسية الدولة بطريق الغش أو بناء على أقوال كاذبة. ويعد مجلس الوزراء هو المختص بإصدار قرارات سحب الجنسية سواء كان السحب حتمياً أو عشرياً." },
    { cat: "الجنسية", q: "حالات إسقاط الجنسية المصرية؟", a: "١- إذا دخل في جنسية أجنبية دون الحصول على إذن بذلك من وزير الداخلية. ٢- إذا قبل الدخول في الخدمة العسكرية لإحدى الدول الأجنبية دون ترخيص سابق يصدر من وزير الحربية. ٣- إذا كانت إقامته العادية في الخارج وصدر حكم بإدانته في جناية من الجنايات المضرة بأمن الدولة من جهة الخارج. ٤- إذا قبل في الخارج وظيفة لدى حكومة أجنبية أو إحدى الهيئات الأجنبية أو الدولية وبقي فيها بالرغم من صدور أمر مسبب إليه من مجلس الوزراء بتركها، إذا كان بقاؤه في هذه الوظيفة من شأنه أن يهدد المصالح العليا للبلاد، وذلك بعد مضي ستة أشهر من تاريخ إخطاره بالأمر المشار إليه في محل وظيفته في الخارج. ٥- إذا كانت إقامته العادية في الخارج وانضم إلى هيئة أجنبية من أغراضها العمل على تقويض النظام الاجتماعي أو الاقتصادي للدولة بالقوة أو بأية وسيلة من الوسائل غير المشروعة. ٦- إذا عمل لمصلحة دولة أو حكومة أجنبية وهي في حالة حرب مع مصر. ٧- الاتصاف بالصهيونية." },
    { cat: "الجنسية", q: "ما هي حالات استرداد الجنسية المصرية؟", a: "يقع الاسترداد في قانون الجنسية المصرى في صورتين: أولاهما معلقة على إرادة الفرد. وثانيهما الاسترداد فيها معلق على تقدير السلطة المختصة. ولهذا يمكننا القول بأن الصورة الأولى للاسترداد تتم بقوة القانون ولكن لابد من تقديم طلب للعودة للجنسية المصرية من قبل ذوي الشأن، فهذا الاسترداد وحرية الجهة المختصة بمنح الجنسية أو استردادها ليس للفرد ذاته. ويمكن حصر حالات الاسترداد بقوة القانون في ثلاث حالات هي: الحالة الأولى: الزوجة التي كانت تتمتع بالجنسية المصرية ثم فقدتها تسترد هذه الجنسية بمجرد منحها لزوجها أو بمجرد زواجها من مصري. الحالة الثانية: تسترد الزوجة المصرية عند انتهاء الزوجية التي كانت سبباً في فقدها لهذه الجنسية من قبل. الحالة الثالثة: استرداد الأولاد القصر لجنسيتهم المصرية التي زالت عنهم تجنس الأب بجنسية أجنبية." },
    { cat: "الجنسية", q: "ما هي رد الجنسية المصرية؟", a: "الحالة الأولى: رد الجنسية المصرية لمن سحبت منه أو أسقطت عنه. يجب توافر شروط ثلاث لتمام الرد في هذه الحالة: الشرط الأول: أن يكون هذا الشخص قد فقد جنسيته المصرية عن طريق سحبها منه أو إسقاطها عنه. الشرط الثاني: أن يكون قد مضى على قرار السحب أو الإسقاط مدة خمس سنوات. الحالة الثانية: رد الجنسية المصرية لمن فقدها لاكتسابه جنسية أجنبية بعد الإذن له في ذلك." },
    { cat: "الجنسية", q: "ما هي طرق اثبات الجنسية المصرية الأصلية؟", a: "١- شهادة الجنسية. ٢- الحالة الظاهرة." },
    { cat: "مركز الأجانب", q: "ما المقصود للأجنبي؟", a: "لم يتضمن قانون الجنسية المصرية تعريفاً للأجنبي ولكن تم تعريفه في قانون دخول الأجانب رقم 89 لسنة 1960 حيث يعتبر هو كل من لا يتمتع بجنسية جمهورية مصر العربية." },
    { cat: "مركز الأجانب", q: "ما المقصود بجوازات السفر؟", a: "هي وثيقة رسمية معترف بها دولياً تصدر من السلطة المختصة في الدولة لإثبات شخصية حامله وجنسيته." },
    { cat: "مركز الأجانب", q: "ما هي شروط دخول الأجنبي جمهورية مصر العربية؟", a: "1- يجب أن يكون الجواز أو الوثيقة مؤشراً علي أيا منهما من وزارة الداخلية او من إحدى البعثات الدبلوماسية. 2- لا يجوز الدخول إلي الأراضي المصرية او الخروج منها الا من الاماكن التي يحددها وزير الداخلية بقرار يصدره وبإذن من الموظف المختص." },
    { cat: "مركز الأجانب", q: "ما المقصود بالتأشيرة؟", a: "الإذن او التوقيع أو العلامة الدالة علي السماح للأجنبي بدخول الدولة." },
    { cat: "مركز الأجانب", q: "ما هي أنواع التأشيرات؟", a: "1. التأشيرات العادية. 2. التأشيرات الدبلوماسية. 3. التأشيرات السياحية. 4. تأشيرات طلاب العلم." },
    { cat: "مركز الأجانب", q: "أذكر تقسيم التأشيرات العادية مبينا تعريف كلا منهم.", a: "تأشيرة الدخول: تصريح صادر من سلطات الدولة المراد دخولها تفيد امكانية دخول الاجنبي إقليمها.\nتأشيرة المرور: الإذن الصادر للأجنبي للمرور خلال الإقليم المصري براً وبحراً وجواً للوصول لدولة أخري وتكون مدتها 7 أيام علي الاكثر ويجوز تقصيرها." },
    { cat: "مركز الأجانب", q: "ما هي شروط الحصول على التأشيرات بصفه عامة؟", a: "1- جواز سفر صحيح ومقر وساري الصلاحية ويمنح حق العودة، واسم مصر ضمن المسموح لهم. 2- جوازات معترف بها صادرة من دول تعترف بها مصر." },
    { cat: "مركز الأجانب", q: "ما هي شروط الحصول على تأشيرة الدخول؟", a: "1- ألا يكون اسمه مدرجاً على قوائم الإرهاب أو الممنوعين. 2- ألا يكون قد غادر البلاد نهائياً ولم تمض سنة على مغادرته (يستثنى رجال الأعمال)." },
    { cat: "مركز الأجانب", q: "ما هي شروط الحصول على تأشيرة المرور؟", a: "1- أن يكون مروره بمصر ضرورياً للوصول لبلد المقصد. 2- أن يكون قد حصل على تأشيرة دخول للبلد الذي يرغب في الذهاب إليه." },
    { cat: "مركز الأجانب", q: "ما هي الجهة المختصة بمنح التأشيرات العادية والتأشيرات الدبلوماسية؟", a: "التأشيرات العادية: وزارة الداخلية وقنصليات الجمهورية في الخارج. التأشيرات الدبلوماسية: وزارة الداخلية والهيئات الدبلوماسية في الخارج." },
    { cat: "مركز الأجانب", q: "اذكر تقسيمات التأشيرات الدبلوماسية مبينا الفئات المستحقة لها؟", a: "الدبلوماسية: لحاملي الجوازات الدبلوماسية وكبار الشخصيات. الخاصة: لحاملي الجوازات الخاصة وموظفي الأمم المتحدة. لمهمة: لحاملي جوازات لمهمة. المجاملة: لموظفي الهيئات الدولية ومن في حكمهم ممن يحملون جوازات عادية." },
    { cat: "مركز الأجانب", q: "ما هي الفئات المستحقة للإقامة الخاصة؟", a: "1) المولودون في مصر قبل 1952 ولم تنقطع إقامتهم. 2) المقيمون في مصر 20 سنة قبل 1952 ولم تنقطع إقامتهم. 3) المقيمون أكثر من 5 سنوات وتجدد بانتظام حتى 1960. 4) العلماء ورجال الأدب والفن والصناعة ممن يؤدون خدمات جليلة." },
    { cat: "مركز الأجانب", q: "ما هي المزايا المقررة للأجانب ذوي الإقامة الخاصة؟", a: "1. يرخص لهم إقامة لمدة 10 سنوات. 2. تتجدد تلقائياً ولا يجوز رفضها. 3. ينتفع بها الأولاد القصر والزوجة (بعد سنتين). 4. لا يبعدون إلا إذا هددوا أمن الدولة." },
    { cat: "مركز الأجانب", q: "من هم الأجانب ذو الإقامة العادية وما الفرق بينها وبين الخاصة؟", a: "هم المقيمون في مصر 15 سنة قبل 1952. الاختلاف: مدة العادية 5 سنوات (الخاصة 10)، تجديدها تقديري (الخاصة بقوة القانون)، قديماً لم تكن تمتد للأسرة لكن المشرع تدارك ذلك." },
    { cat: "مركز الأجانب", q: "اذكر تقسيمات الإقامة المؤقتة؟", a: "• إقامة مؤقتة لمدة 5 سنوات. • إقامة مؤقتة لمدة 3 سنوات. • إقامة مؤقتة لمدة سنة." },
    { cat: "مركز الأجانب", q: "اذكر الفئات المستحقة للإقامة المؤقتة لمدة خمس سنوات؟", a: "المستثمرون، المصري الذي فقد جنسيته، الأجانب فوق 60 عاماً ومقيمون 10 سنوات، زوجات وأرامل المصريين." },
    { cat: "مركز الأجانب", q: "اذكر الفئات المستحقة للإقامة المؤقتة لمدة ثلاث سنوات؟", a: "أزواج المصريات، الأبناء القصر لمن له إقامة خاصة/عادية وتوفي، العاملون بالحكومة والقطاع العام، الفلسطينيون." },
    { cat: "مركز الأجانب", q: "اذكر الفئات المستحقة للإقامة المؤقتة لمدة سنة؟", a: "تمنح للأجانب الذين لا تتوافر فيهم شروط الإقامات الأخرى (الخاصة، العادية، الخماسية، الثلاثية)." },
    { cat: "مركز الأجانب", q: "ما هو المقصود بالإبعاد؟", a: "قرار سيادي من الدولة يلزم أجنبياً أو مجموعة أجانب بالخروج من إقليمها." },
    { cat: "مركز الأجانب", q: "ما الفرق بين الإبعاد وغيره (التسليم، النفي، التكليف بالسفر، المنع)؟", a: "الإبعاد إجراء بوليسي وقائي ضد الأجانب. التسليم يتم بناء على اتفاقية لمتهم بجريمة. النفي يكون للمواطنين. التكليف بالسفر يصدر من الجوازات ويمكن الطعن عليه. المنع من الدخول إجراء وقائي قبل الدخول." },
    { cat: "مركز الأجانب", q: "ما هي أسباب الإبعاد؟", a: "لم يحدد المشرع أسباباً وتركها للسلطة التقديرية لوزير الداخلية، باستثناء ذوي الإقامة الخاصة لا يبعدون إلا لتهديد أمن الدولة." },
    { cat: "مركز الأجانب", q: "ما هي الآثار المترتبة على الإبعاد؟", a: "وجوب مغادرة الأجنبي، ومنعه من دخول البلاد مرة أخرى إلا بإذن صريح." },
    { cat: "مركز الأجانب", q: "ما هي الإجراءات في حال تعذر تنفيذ قرار الإبعاد؟", a: "تحديد إقامة الأجنبي في جهة معينة، والحجز الإداري حتى تتم إجراءات الإبعاد." },
    { cat: "مركز الأجانب", q: "ما المقصود بالترحيل وما هي أسبابه؟", a: "هو قرار من مدير الجوازات بإخراج أجنبي دخل خلسة أو خالف شروط الإقامة. أسبابه: دخول غير مشروع، انتهاء الإقامة، مخالفة غرض الإقامة، عدم المغادرة بعد رفض التجديد." },
    { cat: "مركز الأجانب", q: "ما الفرق بين الترحيل والإبعاد؟", a: "الترحيل لمن دخل خلسة أو خالف القواعد (إجراء إداري من الجوازات)، الإبعاد لمن دخل شرعياً لكنه أصبح خطراً (قرار وزير الداخلية)." },
    { cat: "تنازع القوانين", q: "ما هي نوع العالقات الموجودة في المجتمع الدولي؟", a: "علاقات قانون خاص (أفراد وشركات) تخضع للقانون الدولي الخاص. وعلاقات بين دول ومنظمات تخضع للقانون الدولي العام." },
    { cat: "تنازع القوانين", q: "ما المقصود بالقانون الدولي الخاص؟", a: "مجموعة القواعد القانونية التي تنظم علاقات الأشخاص الخاصة التي تتجاوز حدود الدولة وترتبط بأكثر من نظام قانوني." },
    { cat: "تنازع القوانين", q: "ما هي موضوعات القانون الدولي الخاص؟", a: "الجنسية، مركز الأجانب، تنازع القوانين، الاختصاص القضائي الدولي، تنفيذ الأحكام الأجنبية، الموطن." },
    { cat: "تنازع القوانين", q: "ما هي مصادر القانون الدولي الخاص؟", a: "رسمية: التشريع، العرف، المبادئ، المعاهدات. غير رسمية: القضاء، الفقه." },
    { cat: "تنازع القوانين", q: "ما المقصود بتنازع القوانين؟", a: "تزاحم قوانين دولتين أو أكثر بشأن حكم علاقة من علاقات القانون الخاص ذات عنصر أجنبي." },
    { cat: "تنازع القوانين", q: "ما هي شروط قيام تنازع القوانين؟", a: "1) علاقة قانون خاص ذات عنصر أجنبي. 2) تزاحم قانونين أو أكثر. 3) قوانين دول مستقلة. 4) تنازع قوانين خاصة. 5) اختلاف الأحكام بين القوانين." },
    { cat: "تنازع القوانين", q: "ما المقصود بقاعدة الإسناد؟", a: "قاعدة ترشد القاضي إلى القانون الواجب التطبيق على منازعة تحتوي على عنصر أجنبي." },
    { cat: "تنازع القوانين", q: "ما هي عناصر قاعدة الإسناد؟", a: "1) الفكرة المسندة. 2) ضابط الإسناد. 3) القانون المسند إليه." },
    { cat: "تنازع القوانين", q: "ما هي خصائص قاعدة الإسناد؟", a: "وضعية داخلية، مزدوجة، غير مباشرة، ليس لها مضمون موضوعي، محايدة، ملزمة." },
    { cat: "تنازع القوانين", q: "في أي مواد توجد قواعد الإسناد في التشريع المصري؟", a: "في القانون المدني من المواد 10 إلى 28." },
    { cat: "تنازع القوانين", q: "ما شروط تطبيق قاعدة الإسناد على الشخص الاعتباري؟", a: "أن يكون مركز الإدارة رئيسياً وفعلياً." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق على الحالة المدنية والأهلية؟", a: "قانون الجنسية (قانون الدولة التي ينتمون إليها بجنسيتهم)." },
    { cat: "تنازع القوانين", q: "ما هو استثناء تطبيق القانون الأجنبي في نقص الأهلية؟", a: "في التصرفات المالية في مصر إذا كان نقص الأهلية يرجع لسبب خفي، يطبق القانون المصري حماية للطرف الآخر." },
    { cat: "تنازع القوانين", q: "ما القانون الذي يسري على الشخص الاعتباري؟", a: "قانون الدولة التي يتخذ فيها مركز إدارته الرئيسي الفعلي (إلا إذا باشر نشاطه الرئيسي في مصر فيطبق المصري)." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق على الشروط الموضوعية لصحة الزواج؟", a: "قانون الجنسية المشتركة للزوجين (أو قانون كل منهما إذا اختلفا)." },
    { cat: "تنازع القوانين", q: "هل وضع المشرع قاعدة إسناد للخطبة؟", a: "لا، لم يضع قاعدة خاصة." },
    { cat: "تنازع القوانين", q: "ما القانون الذي يحكم الآثار الشخصية والمالية للزواج؟", a: "قانون جنسية الزوج وقت إبرام العقد." },
    { cat: "تنازع القوانين", q: "ما القانون الذي يخضع له إثبات الزواج؟", a: "الراجح أنه يخضع للقانون الذي يحكم شكله." },
    { cat: "تنازع القوانين", q: "ما القانون الذي يحكم مسائل الولاية على النفس؟", a: "قانون جنسية الأب." },
    { cat: "تنازع القوانين", q: "ما القانون الذي يحكم عمل المرأة المتزوجة بالتجارة؟", a: "قانون الدولة التي تحمل المرأة جنسيتها." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق على شكل الزواج؟", a: "تخييري: قانون بلد الإبرام، أو قانون الموضوع، أو جنسية المتعاقدين، أو موطنهما المشترك." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق على الطلاق والتطليق؟", a: "الطلاق: قانون جنسية الزوج وقت الطلاق. التطليق: قانون جنسية الزوج وقت رفع الدعوى." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق على إجراءات التطليق؟", a: "قانون القاضي (قانون المرافعات المصري)." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق إذا كان أحد الزوجين مصرياً وقت الزواج؟", a: "يطبق القانون المصري (فيما عدا شرط الأهلية)." },
    { cat: "تنازع القوانين", q: "ما القانون الواجب التطبيق على مسائل الولاية والوصاية والقوامة؟", a: "قانون الشخص الذي تجب حمايته." },
    { cat: "تنازع القوانين", q: "ماذا يقصد بالتطبيق الجامع؟", a: "تطبيق حكمي القانونين معاً على كل من الزوج والزوجة." },
    { cat: "تنازع القوانين", q: "ما المقصود بالتطبيق الموزع؟", a: "فصل أحكام قانون الزوج عن الزوجة، وتطبيق كل قانون على الطرف التابع له." },
    { cat: "تنازع القوانين", q: "ما هو التشريع والعرف؟", a: "التشريع: قانون مكتوب صادر عن السلطة. العرف: سلوك مضطرد مع اعتقاد بإلزاميته." },
    { cat: "تنازع القوانين", q: "ما المقصود بمبادئ القانون الدولي الخاص؟", a: "مجموعة الحلول المستخلصة من الأصول الفنية لمادة التنازع." },
    { cat: "تنازع القوانين", q: "ما المقصود بالمعاهدات والقضاء والفقه؟", a: "المعاهدات: اتفاقات دولية. القضاء: أحكام المحاكم المستقرة. الفقه: آراء علماء القانون." },
    { cat: "تنازع القوانين", q: "هل القانون الدولي الخاص عام أم خاص؟", a: "الجنسية ومركز الأجانب (حقوق عامة) = عام. تنازع القوانين والاختصاص = خاص." },
    { cat: "تنازع القوانين", q: "ماذا يقصد بالفكرة المسندة؟", a: "مجموعة المراكز أو العلاقات القانونية المتقاربة التي تجمعها فكرة مشتركة واحدة." },
    { cat: "تنازع القوانين", q: "ماذا يقصد بضابط الإسناد؟", a: "المعيار الذي يختاره المشرع للإشارة إلى القانون الأفضل لحكم الفكرة المسندة." },
    { cat: "تنازع القوانين", q: "ما المقصود بالقانون المسند إليه؟", a: "هو القانون المختص بحكم العلاقة بناء على ضابط الإسناد." },
    { cat: "تنازع القوانين", q: "اذكر قاعدة إسناد بظرف واحد؟", a: "الميراث يحكمه قانون جنسية المورث." },
    { cat: "تنازع القوانين", q: "اذكر قاعدة إسناد متدرجة؟", a: "الالتزامات التعاقدية: قانون الموطن المشترك، فإن اختلف فقانون محل التعاقد، ما لم يتفقا على غير ذلك." },
    { cat: "تنازع القوانين", q: "اذكر قاعدة إسناد تخييرية؟", a: "شكل العقود: يخضع لقانون بلد الإبرام، أو القانون الموضوعي، أو قانون الموطن المشترك، أو القانون الوطني المشترك." }
];

export default function Home() {
    const [currentScreen, setCurrentScreen] = useState('home');
    const [currentCards, setCurrentCards] = useState([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    const [isFlipped, setIsFlipped] = useState(false);
    const [isCompleted, setIsCompleted] = useState(false);

    // Speech & AI Logic State
    const [inputMode, setInputMode] = useState('voice'); // 'voice' or 'text'
    const [textInput, setTextInput] = useState("");
    const [isRecording, setIsRecording] = useState(false);
    const [processing, setProcessing] = useState(false);
    const [userTranscript, setUserTranscript] = useState("...");
    const [matchScore, setMatchScore] = useState(0);
    const [matchColor, setMatchColor] = useState("var(--text-secondary)");
    const [aiFeedback, setAiFeedback] = useState("");
    const [transcriptDiff, setTranscriptDiff] = useState([]); // Kept for state compatibility but unused in UI

    const mediaRecorderRef = useRef(null);
    const chunksRef = useRef([]);

    // Arabic Stop Words (Common prepositions and fillers to ignore/gray out)
    const ARABIC_STOP_WORDS = new Set([
        "في", "من", "على", "الى", "إلى", "عن", "مع", "ان", "أن", "او", "أو",
        "ما", "هل", "لا", "هو", "هي", "هم", "هذا", "هذه", "ذلك", "الذي", "التي",
        "و", "ف", "ب", "ك", "ل", "يا", "اما", "أما", "ثم", "بل", "لكن", "جدا", "جداً"
    ]);

    const startStudy = (category) => {
        let filtered = [];
        if (category === 'all') {
            filtered = [...originalData];
        } else {
            filtered = originalData.filter(item => item.cat === category);
        }
        // No Shuffle - Keep original order
        setCurrentCards(filtered);
        setCurrentIndex(0);
        setIsFlipped(false);
        setIsCompleted(false);
        resetSpeechState();
        setCurrentScreen('study');
    };

    const resetSpeechState = () => {
        setTranscriptDiff([]);
        setMatchScore(0);
        setMatchColor("var(--text-secondary)");
        setAiFeedback("");
        setUserTranscript("...");
        setTextInput(""); // Clear text input
        setIsRecording(false);
        setProcessing(false);
    };

    const goHome = () => {
        setCurrentScreen('home');
        if (isRecording) stopRecording();
    };

    const flipCard = () => {
        setIsFlipped(!isFlipped);
    };

    const nextCard = (e) => {
        e.stopPropagation();
        if (currentIndex < currentCards.length - 1) {
            setCurrentIndex(prev => prev + 1);
            setIsFlipped(false);
            resetSpeechState();
        } else {
            setIsCompleted(true);
        }
    };

    const prevCard = (e) => {
        e.stopPropagation();
        if (currentIndex > 0) {
            setCurrentIndex(prev => prev - 1);
            setIsFlipped(false);
            resetSpeechState();
        }
    };

    // --- Audio Recording Logic ---
    const toggleRecording = async () => {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    };

    const startRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorderRef.current = new MediaRecorder(stream);
            chunksRef.current = [];

            mediaRecorderRef.current.ondataavailable = (e) => {
                if (e.data.size > 0) chunksRef.current.push(e.data);
            };

            mediaRecorderRef.current.onstop = async () => {
                const blob = new Blob(chunksRef.current);
                await processAudio(blob);
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorderRef.current.start();
            setIsRecording(true);
            setUserTranscript("جاري الاستماع...");
            setAiFeedback("");
        } catch (err) {
            console.error("Mic Error:", err);
            alert("يرجى السماح باستخدام الميكروفون.");
        }
    };

    const stopRecording = () => {
        if (mediaRecorderRef.current && isRecording) {
            mediaRecorderRef.current.stop();
            setIsRecording(false);
            setProcessing(true);
            setUserTranscript("جاري معالجة الصوت...");
        }
    };

    const handleTextSubmit = () => {
        if (!textInput.trim()) return;

        const text = textInput;
        setUserTranscript(text);
        analyzeTranscript(text, currentCards[currentIndex].a);
    };

    const processAudio = async (blob) => {
        const formData = new FormData();
        formData.append('file', blob, 'audio.webm');

        try {
            // 1. Transcribe
            const res = await fetch('/api/transcribe', {
                method: 'POST',
                body: formData,
            });

            if (!res.ok) throw new Error('Transcription failed');

            const data = await res.json();
            const text = data.text || "";
            setUserTranscript(text);

            // 2. Static Analysis
            if (text.trim().length > 0) {
                analyzeTranscript(text, currentCards[currentIndex].a);
            } else {
                setMatchScore(0);
                setTranscriptDiff([]);
            }

        } catch (error) {
            console.error(error);
            setUserTranscript("حدث خطأ في المعالجة. حاول مرة أخرى.");
        } finally {
            setProcessing(false);
        }
    };

    const analyzeTranscript = (userText, idealText) => {
        const tokens = userText.split(/([^\w\u0600-\u06FF]+)/g);

        // Normalize helper
        const normalize = (t) => {
            return t
                .replace(/[^\w\s\u0600-\u06FF]/g, ' ')
                .replace(/[أإآ]/g, 'ا')
                .replace(/ة/g, 'ه')
                .replace(/ى/g, 'ي')
                .replace(/\s+/g, ' ')
                .trim()
                .toLowerCase();
        };

        const idealNormalized = normalize(idealText);
        const idealWordsSet = new Set(idealNormalized.split(' ').filter(w => w.length > 0));

        let matchCount = 0;

        const diff = tokens.map((token, index, arr) => {
            if (/[\w\u0600-\u06FF]/.test(token)) {
                // It is a word
                const normalizedToken = normalize(token);
                if (idealWordsSet.has(normalizedToken)) {
                    matchCount++;
                    return { text: token, status: 'match' };
                } else {
                    // Check if it's the last token (currently being typed)
                    if (index === arr.length - 1) {
                        return { text: token, status: 'typing' };
                    }
                    return { text: token, status: 'wrong' };
                }
            } else {
                // It is a separator/space
                return { text: token, status: 'neutral' };
            }
        });

        // Calculate Score
        const idealLen = idealWordsSet.size;
        const totalPossible = idealLen > 0 ? idealLen : 1;
        const percentage = Math.min(Math.round((matchCount / totalPossible) * 100), 100);

        setMatchScore(percentage);
        setTranscriptDiff(diff);

        // Set Color
        if (percentage > 80) setMatchColor("#34C759");
        else if (percentage > 50) setMatchColor("#FF9500");
        else setMatchColor("#FF3B30");
    };

    // Helper to format answers
    const formatAnswer = (text) => {
        if (!text) return text;

        // Regex to identify list items (numbered 1), 1-, bullet points, or specific Arabic keywords like "First", "The first pillar")
        const listPattern = /(?:^|\s)((?:[\d١-٩]+[\)\-\.])|(?:[-•])|(?:أولاً|ثانياً|ثالثاً|رابعاً|خامساً)(?:\s*[-:])?|(?:(?:الركن|الحالة|الشرط|الطائفة|السبب)\s+(?:الأول|الثاني|الثالث|الرابع|الخامس|الأولى|الثانية|الثالثة|الرابعة|الخامسة)(?:\s*[:])?))/g;

        // Check if text contains these patterns
        if (listPattern.test(text)) {
            // Split text by these patterns, but keep the delimiter (using capture group in split is tricky, better to mark and split)
            // We will insert a special marker before the match
            const markedText = text.replace(listPattern, "\n$1");
            const lines = markedText.split('\n').map(l => l.trim()).filter(l => l);

            if (lines.length > 1) {
                return (
                    <div className="answer-list-container">
                        {lines.map((line, idx) => (
                            <div key={idx} className="answer-line">{line}</div>
                        ))}
                    </div>
                );
            }
        }

        // If simply long text (> 100 chars), reduce font
        if (text.length > 100) {
            return <div className="long-text-answer">{text}</div>;
        }

        return text;
    };

    return (
        <main style={{ width: '100%', height: '100%' }}>
            {currentScreen === 'home' && (
                <div id="homeScreen">
                    <div className="hero-section">
                        <h1>القانون الدولي الخاص</h1>
                        <p>منصة المراجعة الذكية للتدريب الشفوي - اختر قسماً وابدأ الآن</p>
                    </div>

                    <div className="cards-grid">
                        <div className="category-card" style={{ '--card-color': 'var(--accent-nation)', '--icon-bg': '#e3f2fd' }}
                            onClick={() => startStudy('الجنسية')}>
                            <div className="cat-icon-box">🏛️</div>
                            <div className="cat-title">الجنسية</div>
                            <div className="cat-meta">50 سؤال</div>
                        </div>

                        <div className="category-card" style={{ '--card-color': 'var(--accent-foreign)', '--icon-bg': '#e0f2f1' }}
                            onClick={() => startStudy('مركز الأجانب')}>
                            <div className="cat-icon-box">✈️</div>
                            <div className="cat-title">مركز الأجانب</div>
                            <div className="cat-meta">25 سؤال</div>
                        </div>

                        <div className="category-card" style={{ '--card-color': 'var(--accent-conflict)', '--icon-bg': '#fbe9e7' }}
                            onClick={() => startStudy('تنازع القوانين')}>
                            <div className="cat-icon-box">⚖️</div>
                            <div className="cat-title">تنازع القوانين</div>
                            <div className="cat-meta">40 سؤال</div>
                        </div>

                        <div className="category-card" style={{ '--card-color': 'var(--accent-main)', '--icon-bg': '#ede7f6' }}
                            onClick={() => startStudy('all')}>
                            <div className="cat-icon-box">📚</div>
                            <div className="cat-title">المنهج كاملاً</div>
                            <div className="cat-meta">115 سؤال</div>
                        </div>
                    </div>
                </div>
            )}

            {currentScreen === 'study' && currentCards.length > 0 && (
                <div id="studyScreen">
                    {!isCompleted ? (
                        <>
                            <div className="study-header">
                                <button className="back-button" onClick={goHome}>
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                                    </svg>
                                    الرئيسية
                                </button>
                                <div className="progress-container">
                                    <span className="progress-numbers">{currentIndex + 1} / {currentCards.length}</span>
                                    <div className="progress-bar-bg">
                                        <div className="progress-bar-fill" style={{ width: `${((currentIndex + 1) / currentCards.length) * 100}%` }}></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flashcard-container">
                                <div className={`flashcard-inner ${isFlipped ? 'flipped' : ''}`} onClick={flipCard}>
                                    <div className="flashcard-face flashcard-front">
                                        <span className="card-tag" style={{ background: '#f1f2f6', color: '#a4b0be' }}>
                                            {currentCards[currentIndex].cat}
                                        </span>
                                        <div className="content-text">
                                            {currentCards[currentIndex].q}
                                        </div>
                                        <div className="card-instruction">اضغط لإظهار الإجابة</div>
                                    </div>
                                    <div className="flashcard-face flashcard-back">
                                        <div className="content-text">
                                            {formatAnswer(currentCards[currentIndex].a)}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="controls-wrapper" style={{ position: 'relative', flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>
                                {/* Button removed from here */}
                                <div className="nav-actions">
                                    <button className="nav-btn" onClick={nextCard} disabled={currentIndex === currentCards.length - 1}>
                                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" /></svg>
                                    </button>

                                    {inputMode === 'voice' && (
                                        <button
                                            className={`mic-btn ${isRecording ? 'listening' : ''}`}
                                            onClick={toggleRecording}
                                            disabled={processing}
                                        >
                                            {processing ? '⏳' : (isRecording ? '⏹️ إيقاف' : '🎙️ إجابة')}
                                        </button>
                                    )}

                                    <button className="nav-btn" onClick={prevCard} disabled={currentIndex === 0}>
                                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" /></svg>
                                    </button>
                                </div>
                            </div>

                            <div className="rich-input-wrapper">
                                <div className="rich-backdrop">
                                    {transcriptDiff.length > 0 ? (
                                        transcriptDiff.map((item, idx) => (
                                            <span key={idx} style={{
                                                color: item.status === 'match' ? '#34C759' :
                                                    item.status === 'wrong' ? '#FF3B30' :
                                                        item.status === 'typing' ? '#8E8E93' : 'transparent',
                                            }}>
                                                {item.text}
                                            </span>
                                        ))
                                    ) : (
                                        <div style={{ color: '#ccc', direction: 'rtl', textAlign: 'right' }}>
                                            {inputMode === 'voice' ? '...' : 'اكتب إجابتك هنا...'}
                                        </div>
                                    )}
                                </div>

                                {inputMode === 'text' && (
                                    <textarea
                                        className="rich-textarea"
                                        value={textInput}
                                        onChange={(e) => {
                                            const val = e.target.value;
                                            setTextInput(val);
                                            setUserTranscript(val);
                                            if (val.trim()) {
                                                analyzeTranscript(val, currentCards[currentIndex].a);
                                            } else {
                                                setMatchScore(0);
                                                setTranscriptDiff([]);
                                            }
                                        }}
                                        spellCheck="false"
                                    />
                                )}
                            </div>

                            {/* Score Display Only */}
                            <div style={{
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center',
                                marginTop: '-5px',
                                marginBottom: '10px',
                                padding: '0 10px'
                            }}>
                                <span style={{ color: matchColor, fontSize: '1.5rem', fontWeight: 'bold' }}>{matchScore}%</span>
                            </div>

                            {/* Toggle Button - Fixed at Bottom Left of Screen */}
                            <button className="mode-toggle-btn"
                                style={{
                                    position: 'fixed',
                                    bottom: '20px',
                                    left: '20px',
                                    zIndex: 1000,
                                    margin: 0,
                                    width: '45px',
                                    height: '45px',
                                    borderRadius: '50%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    background: 'white',
                                    boxShadow: '0 4px 15px rgba(0,0,0,0.1)',
                                    border: '1px solid rgba(0,0,0,0.05)',
                                    fontSize: '1.2rem',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1)'
                                }}
                                onClick={() => {
                                    setInputMode(prev => prev === 'voice' ? 'text' : 'voice');
                                    resetSpeechState();
                                }}>
                                {inputMode === 'voice' ? '⌨️' : '🎙️'}
                            </button>
                        </>
                    ) : (
                        <div className="completion-screen">
                            <div className="completion-icon">🎉</div>
                            <div className="completion-title">أحسنت!</div>
                            <div className="completion-text">
                                لقد أتممت جميع أسئلة هذا القسم بنجاح.<br />
                                استمر في التدريب لتحقيق التفوق.
                            </div>
                            <button className="mic-btn" style={{ width: 'auto', padding: '0 40px' }} onClick={goHome}>
                                العودة للرئيسية
                            </button>
                        </div>
                    )}
                </div>
            )
            }
            {currentScreen === 'home' && <div className="dev-footer">© 7𝖊$𝖊𝒏</div>}
        </main >
    );
}
